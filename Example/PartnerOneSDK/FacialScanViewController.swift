import UIKit
import FaceTecSDK

final class FacialScanViewController: UIViewController, FaceTecFaceScanProcessorDelegate, URLSessionDelegate {
  
  //MARK: - Properties
  
  var viewModel: ScanViewModel
  var helper: PartnerHelper
  
  private var latestExternalDatabaseRefID: String = ""
  private var latestSessionResult: FaceTecSessionResult!
  private var latestIDScanResult: FaceTecIDScanResult!
  private var sessionResult: FaceTecSessionResult?
  private var resultCallback: FaceTecFaceScanResultCallback?
  private var latestProcessor: Processor!
  private var utils: SampleAppUtilities?
  
  public var faceScanBase64: String = ""
  
  var sessionId: String?
  var deviceKey: String?
  var transactionId: String?
  var processorResponse: (() -> Void)?
  
  //MARK: - init
  
  init(viewModel: ScanViewModel, helper: PartnerHelper) {
    self.viewModel = viewModel
    self.helper = helper
    super.init(nibName: nil, bundle: nil)
  }
  
  required init?(coder: NSCoder) {
    fatalError("init(coder:) has not been implemented")
  }
  
  //MARK: - View Lifecycle
  
  override func viewDidLoad() {
    super.viewDidLoad()
    
    navigationItem.hidesBackButton = true
    view.backgroundColor = .white
  }
  
  override func viewWillAppear(_ animated: Bool) {
    super.viewWillAppear(animated)
    FaceTec.initialize()
    setupFaceTec()
  }
}

//MARK: - Private Functions

extension FacialScanViewController {
  func setupFaceTec() {
    self.transactionId = helper.transaction
    self.deviceKey = helper.faceTecDeviceKeyIdentifier
    self.sessionId = helper.sessionToken
    
    FaceTec.sdk.initializeInProductionMode(productionKeyText: Config.ProductionKeyText,
                                           deviceKeyIdentifier: Config.DeviceKeyIdentifier,
                                           faceScanEncryptionKey: Config.PublicFaceScanEncryptionKey)
    
    Config.initializeFaceTecSDKFromAutogeneratedConfig(completion: { [weak self] initializationSuccessful in
      guard let self = self else {
        return
      }
      ThemeHelpers.setAppTheme(theme: "")
      Config.displayLogs()
      
      self.initializeProcessor()
      self.faceTecLivenessData(completion: {})
      
      self.processorResponse = {
        if self.resultCallback?.onFaceScanGoToNextStep(scanResultBlob: "") != nil {
          print("BLOB!")
          
        } else {
          self.navigationController?.popViewController(animated: true)
        }
      }
    })
  }
  
  func processSessionWhileFaceTecSDKWaits(sessionResult: FaceTecSessionResult,
                                          faceScanResultCallback: FaceTecFaceScanResultCallback) {
    self.resultCallback = faceScanResultCallback
  }
  
  func onFaceTecSDKCompletelyDone() {
    print("@! >>> Escaneamento Completo. Navegando para Status!")
  }
  
  func onComplete() {
    helper.navigateToStatus?()
  }
  
  func getLatestExternalDatabaseRefID() -> String {
    return latestExternalDatabaseRefID;
  }
  
  func setLatestSessionResult(sessionResult: FaceTecSessionResult) {
    latestSessionResult = sessionResult
  }
  
  func initializeProcessor() -> LivenessCheckProcessor {
    return LivenessCheckProcessor(sessionToken: helper.sessionToken, fromViewController: self)
  }
  
  public func createUserAgentForNewSession() -> String {
    return FaceTec.sdk.createFaceTecAPIUserAgentString("")
  }
  
  public func createUserAgentForSession(_ sessionId: String) -> String {
    return FaceTec.sdk.createFaceTecAPIUserAgentString(sessionId)
  }
  
  public func faceTecLivenessData(faceScanBase: String = "",
                                  auditTrailImage: String = "",
                                  lowQualityAuditTrailImage: String = "",
                                  completion: @escaping (() -> Void)) {
    self.helper.getFaceScan = faceScanBase
    self.helper.getAuditTrailImage = auditTrailImage
    self.helper.getLowQualityAuditTrailImage = lowQualityAuditTrailImage
    
    completion()
    
    PartnerHelper.livenessCallBack = { (faceScan, auditTrailImage, lowQualityAuditTrailImage) in
      self.helper.getFaceScan = faceScan
      self.helper.getAuditTrailImage = auditTrailImage
      self.helper.getLowQualityAuditTrailImage = lowQualityAuditTrailImage
    }
    
    print("@! >>> Processamento finalizado.")
    
    self.initializeProcessor().success = true
    self.initializeProcessor().faceScanResultCallback = resultCallback
  }
}
